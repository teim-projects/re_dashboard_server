{% extends "basewind.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container my-4">
  <h3 class="text-center mb-4 fw-bold text-primary">âš¡ WTG Wise Generation (kWh)</h3>
  <hr class="mb-4">

  <!-- Active filters chips -->
<!-- Active filters chips -->
<div class="d-flex flex-wrap align-items-center gap-2 mb-3">
  {% if date_from or date_to or selected_providers or selected_customers or selected_states or selected_sites or selected_wtgs %}
    <span class="badge bg-secondary">Active filters:</span>
    {% if date_from %}<span class="badge bg-light text-dark">From: {{ date_from }}</span>{% endif %}
    {% if date_to %}<span class="badge bg-light text-dark">To: {{ date_to }}</span>{% endif %}
    {% for x in selected_providers %}<span class="badge bg-info text-dark">Provider: {{ x }}</span>{% endfor %}
    {% for x in selected_customers %}<span class="badge bg-info text-dark">Customer: {{ x }}</span>{% endfor %}
    {% for x in selected_states %}<span class="badge bg-info text-dark">State: {{ x }}</span>{% endfor %}
    {% for x in selected_sites %}<span class="badge bg-info text-dark">Site: {{ x }}</span>{% endfor %}
    {% for x in selected_wtgs %}<span class="badge bg-info text-dark">WTG: {{ x }}</span>{% endfor %}
    <a class="btn btn-sm btn-outline-danger ms-2" href="?">Clear all</a>
  {% endif %}
</div>


<!-- Filter Buttons -->
<div class="d-flex flex-wrap gap-2 mb-4">
  <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#dateRangeModal">
    <i class="fas fa-filter"></i> DATE RANGE
  </button>
  <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#providerModal">
    <i class="fas fa-filter"></i> OEM PROVIDER
  </button>
  <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#customerModal">
    <i class="fas fa-filter"></i> CUSTOMER
  </button>
  <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#stateModal">
    <i class="fas fa-filter"></i> STATE NAME
  </button>
  <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#siteModal">
    <i class="fas fa-filter"></i> SITE NAME
  </button>
  <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#wtgModal">
    <i class="fas fa-filter"></i> WTG NUMBER
  </button>
</div>

  <!-- Chart + Table -->
  <div class="row">
    <!-- Treemap Chart -->
    <div class="col-md-8 mb-4">
      <div class="card shadow-lg border-0 h-100 chart-card">
        <div class="card-header form-heading">
          <strong>WTG Wise Generation</strong>
        </div>
        <div class="card-body">
          <canvas id="treemapChart" style="height:400px; width:100%"></canvas>
          <h5 class="mt-3 text-center text-success">
            Day Generation kWh Total: {{ total_generation|intcomma }}
          </h5>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="col-md-4 mb-4">
      <div class="card shadow-lg border-0 h-100">
        <div class="card-header form-heading">
          <strong>WTG No. & Generation</strong>
        </div>
        <div class="card-body">
          <table id="wtgTable" class="table table-bordered table-striped table-hover text-center">
            <thead class="table-light">
              <tr>
                <th>WTG No</th>
                <th>Generation</th>
              </tr>
            </thead>
            <tbody id="wtgTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

         
 
<!-- Date Range Modal -->
<div class="modal fade" id="dateRangeModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select Date Range</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body d-flex gap-2">
        <input type="date" name="date_from" value="{{ date_from }}" class="form-control">
        <input type="date" name="date_to" value="{{ date_to }}" class="form-control">
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key not in "date_from,date_to" %}
          {% for v in vals %}
            <input type="hidden" name="{{ key }}" value="{{ v }}">
          {% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Apply</button>
      </div>
    </form>
  </div>
</div>

<!-- Provider Modal -->
<div class="modal fade" id="providerModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Select Provider(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        {% for p in providers %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="provider" value="{{ p }}"
             {% if not selected_providers or p in selected_providers %}checked{% endif %}>
          <label class="form-check-label">{{ p }}</label>
          </div>
        {% empty %}<p class="text-muted">No providers found.</p>{% endfor %}
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key != "provider" %}
          {% for v in vals %}<input type="hidden" name="{{ key }}" value="{{ v }}">{% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer"><button type="submit" class="btn btn-primary">Apply</button></div>
    </form>
  </div>
</div>
<!-- Customer Modal -->
<div class="modal fade" id="customerModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Select Customer(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        {% for c in customers %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="customer" value="{{ c }}"
              {% if not selected_customers or c in selected_customers %}checked{% endif %}>
            <label class="form-check-label">{{ c }}</label>
          </div>
        {% empty %}<p class="text-muted">No customers found.</p>{% endfor %}
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key != "customer" %}
          {% for v in vals %}<input type="hidden" name="{{ key }}" value="{{ v }}">{% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer"><button type="submit" class="btn btn-primary">Apply</button></div>
    </form>
  </div>
</div>

<!-- State Modal -->
<div class="modal fade" id="stateModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Select State(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        {% for s in states %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="state" value="{{ s }}"
              {% if not selected_states or s in selected_states %}checked{% endif %}>
            <label class="form-check-label">{{ s }}</label>
          </div>
        {% empty %}<p class="text-muted">No states found.</p>{% endfor %}
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key != "state" %}
          {% for v in vals %}<input type="hidden" name="{{ key }}" value="{{ v }}">{% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer"><button type="submit" class="btn btn-primary">Apply</button></div>
    </form>
  </div>
</div>

<!-- Site Modal -->
<div class="modal fade" id="siteModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Select Site(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        {% for s in sites %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="site" value="{{ s }}"
              {% if not selected_sites or s in selected_sites %}checked{% endif %}>
            <label class="form-check-label">{{ s }}</label>
          </div>
        {% empty %}<p class="text-muted">No sites found.</p>{% endfor %}
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key != "site" %}
          {% for v in vals %}<input type="hidden" name="{{ key }}" value="{{ v }}">{% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer"><button type="submit" class="btn btn-primary">Apply</button></div>
    </form>
  </div>
</div>


<!-- WTG Modal -->
<div class="modal fade" id="wtgModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select WTG(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% for w in wtgs %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="wtg" value="{{ w }}"
              {% if not selected_wtgs or w in selected_wtgs %}checked{% endif %}>
            <label class="form-check-label">{{ w }}</label>
          </div>
        {% empty %}
          <p class="text-muted">No WTG numbers found.</p>
        {% endfor %}
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key != "wtg" %}
          {% for v in vals %}
            <input type="hidden" name="{{ key }}" value="{{ v }}">
          {% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Apply</button>
      </div>
    </form>
  </div>
</div>

 {% if no_data %}
<script>
    Swal.fire({
        icon: 'info',
        title: 'No Data Available',
        text: '{{ no_data_msg }}',
        confirmButtonColor: '#3085d6'
    });
</script>
{% endif %}

<!-- Styles -->
<style>
  .chart-card { border-radius: 15px; }
  .form-heading {
    background: linear-gradient(to right, #7b2cbf, #9d4edd);
    color: #fff;
    padding: 15px 25px;
    border-top-left-radius: 15px !important;
    border-top-right-radius: 15px !important;
    font-size: 18px;
    font-weight: 500;
    text-align: center !important;
  }
</style>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0"></script>
<script>
  const rawData = {{ chart_data|safe }};

  // Table fill
  const tableBody = document.getElementById("wtgTableBody");
  tableBody.innerHTML = "";
rawData.forEach(row => {
  if (row.generation) {   // skips null, undefined, 0
    const tr = `<tr><td>${row.wtg}</td><td>${row.generation.toLocaleString()}</td></tr>`;
    tableBody.insertAdjacentHTML("beforeend", tr);
  }
});

  // Colors
  const colors = rawData.map((_, i) => {
    const palette = ["#007bff","#28a745","#ffc107","#dc3545","#17a2b8","#6f42c1","#fd7e14","#20c997"];
    return palette[i % palette.length];
  });

  new Chart(document.getElementById("treemapChart"), {
    type: 'treemap',
    data: {
      datasets: [{
        tree: rawData,
        key: 'generation',
        groups: ['wtg'],
         borderColor: '#fff',
        layoutAlgorithm: 'binary',
        minVisibleSize: 20,
        labels: {
          display: true,
          formatter: ctx => ctx.raw._data.wtg,
          align: 'center',
          color: 'white',
          font: { size: 12  }
        },
        backgroundColor: (ctx) => colors[ctx.index % colors.length]
      }]
    },
    options: {
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => {
              const wtg = ctx.raw._data.wtg;
              const gen = ctx.raw._data.generation;
              const total = rawData.reduce((s, d) => s + d.generation, 0);
              const percent = total ? ((gen / total) * 100).toFixed(1) : 0;
              return `${wtg}: ${gen.toLocaleString()} kWh (${percent}%)`;
            }
          }
        }
      }
    }
  });
</script>
{% endblock %}
