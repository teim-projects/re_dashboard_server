{% extends "basewind.html" %}
{% load static %}
{% block content %}
<div class="container my-4" style="margin-top: 100px !important;">

    <!-- ===== Active Filters ===== -->
    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
        {% if date_from or date_to or selected_providers or selected_customers or selected_states or selected_sites or selected_wtgs %}
            <span class="badge bg-secondary fw-bold">Active Filters:</span>
            {% if date_from %}<span class="badge bg-light text-dark">From: {{ date_from }}</span>{% endif %}
            {% if date_to %}<span class="badge bg-light text-dark">To: {{ date_to }}</span>{% endif %}
            {% for x in selected_providers %}<span class="badge bg-info text-dark">Provider: {{ x }}</span>{% endfor %}
            {% for x in selected_customers %}<span class="badge bg-info text-dark">Customer: {{ x }}</span>{% endfor %}
            {% for x in selected_states %}<span class="badge bg-info text-dark">State: {{ x }}</span>{% endfor %}
            {% for x in selected_sites %}<span class="badge bg-info text-dark">Site: {{ x }}</span>{% endfor %}
            {% for x in selected_wtgs %}<span class="badge bg-info text-dark">WTG: {{ x }}</span>{% endfor %}
            <a class="btn btn-sm btn-outline-danger ms-2" href="?">Clear All</a>
        {% endif %}
    </div>

    <!-- ===== Filter Buttons ===== -->
    <div class="row g-2 mb-4">
        <div class="col-auto">
            <button class="btn btn-outline-dark w-100" data-bs-toggle="modal" data-bs-target="#dateRangeModal">
                <i class="fas fa-calendar-alt"></i> Date Range
            </button>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-dark w-100" data-bs-toggle="modal" data-bs-target="#providerModal">
                <i class="fas fa-industry"></i> Provider
            </button>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-dark w-100" data-bs-toggle="modal" data-bs-target="#customerModal">
                <i class="fas fa-user"></i> Customer
            </button>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-dark w-100" data-bs-toggle="modal" data-bs-target="#stateModal">
                <i class="fas fa-map-marker-alt"></i> State
            </button>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-dark w-100" data-bs-toggle="modal" data-bs-target="#siteModal">
                <i class="fas fa-building"></i> Site
            </button>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-dark w-100" data-bs-toggle="modal" data-bs-target="#wtgModal">
                <i class="fas fa-turbine"></i> WTG
            </button>
        </div>
    </div>

    {% if no_data %}
        <div class="alert alert-warning text-center fw-bold">{{ no_data_msg }}</div>
    {% else %}
        <!-- ===== Treemap Chart Card ===== -->
        <div class="card shadow-lg mb-4 border-0">
            <div class="card-header bg-gradient-primary text-white text-center fw-bold">
                Generation Hours Treemap
            </div>
            <div class="card-body p-3" style="height: 450px;">
                <canvas id="treemapChart"></canvas>
            </div>
            <div class="text-center mb-3">
                <h5 class="fw-bold">Total Hours: {{ total_hours|floatformat:2 }}</h5>
            </div>
        </div>

        <!-- ===== Table Card ===== -->
        <div class="card shadow-lg mb-4 border-0">
            <div class="card-header bg-gradient-secondary text-white text-center fw-bold">
                Generation Hours Table
            </div>
            <div class="card-body p-2">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-bordered text-center mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>WTG No</th>
                                <th>Year</th>
                                <th>Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in table_data %}
                                <tr>
                                    <td>{{ row.wtg_no }}</td>
                                    <td>{{ row.year }}</td>
                                    <td>{{ row.hours|floatformat:2 }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- ===== Modals ===== -->

<!-- ========== Modals ========== --> 
<!-- Date Range Modal -->
<div class="modal fade" id="dateRangeModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select Date Range</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body d-flex gap-2">
        <input type="date" name="date_from" value="{{ date_from }}" class="form-control">
        <input type="date" name="date_to" value="{{ date_to }}" class="form-control">
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key not in "date_from,date_to" %}
          {% for v in vals %}
            <input type="hidden" name="{{ key }}" value="{{ v }}">
          {% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Apply</button>
      </div>
    </form>
  </div>
</div>

<!-- Provider Modal -->
<div class="modal fade" id="providerModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Select Provider(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        {% for p in providers %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="provider" value="{{ p }}"
             {% if not selected_providers or p in selected_providers %}checked{% endif %}>
          <label class="form-check-label">{{ p }}</label>
          </div>
        {% empty %}<p class="text-muted">No providers found.</p>{% endfor %}
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key != "provider" %}
          {% for v in vals %}<input type="hidden" name="{{ key }}" value="{{ v }}">{% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer"><button type="submit" class="btn btn-primary">Apply</button></div>
    </form>
  </div>
</div>
<!-- Customer Modal -->
<div class="modal fade" id="customerModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Select Customer(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        {% for c in customers %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="customer" value="{{ c }}"
              {% if not selected_customers or c in selected_customers %}checked{% endif %}>
            <label class="form-check-label">{{ c }}</label>
          </div>
        {% empty %}<p class="text-muted">No customers found.</p>{% endfor %}
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key != "customer" %}
          {% for v in vals %}<input type="hidden" name="{{ key }}" value="{{ v }}">{% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer"><button type="submit" class="btn btn-primary">Apply</button></div>
    </form>
  </div>
</div>

<!-- State Modal -->
<div class="modal fade" id="stateModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Select State(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        {% for s in states %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="state" value="{{ s }}"
              {% if not selected_states or s in selected_states %}checked{% endif %}>
            <label class="form-check-label">{{ s }}</label>
          </div>
        {% empty %}<p class="text-muted">No states found.</p>{% endfor %}
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key != "state" %}
          {% for v in vals %}<input type="hidden" name="{{ key }}" value="{{ v }}">{% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer"><button type="submit" class="btn btn-primary">Apply</button></div>
    </form>
  </div>
</div>

<!-- Site Modal -->
<div class="modal fade" id="siteModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Select Site(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        {% for s in sites %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="site" value="{{ s }}"
              {% if not selected_sites or s in selected_sites %}checked{% endif %}>
            <label class="form-check-label">{{ s }}</label>
          </div>
        {% empty %}<p class="text-muted">No sites found.</p>{% endfor %}
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key != "site" %}
          {% for v in vals %}<input type="hidden" name="{{ key }}" value="{{ v }}">{% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer"><button type="submit" class="btn btn-primary">Apply</button></div>
    </form>
  </div>
</div>


<!-- WTG Modal -->
<div class="modal fade" id="wtgModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select WTG(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% for w in wtgs %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="wtg" value="{{ w }}"
              {% if not selected_wtgs or w in selected_wtgs %}checked{% endif %}>
            <label class="form-check-label">{{ w }}</label>
          </div>
        {% empty %}
          <p class="text-muted">No WTG numbers found.</p>
        {% endfor %}
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key != "wtg" %}
          {% for v in vals %}
            <input type="hidden" name="{{ key }}" value="{{ v }}">
          {% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Apply</button>
      </div>
    </form>
  </div>
</div>
 
 
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0"></script>

<script>
const rawData = {{ chart_data|safe }};
const years = [...new Set(rawData.map(item => item.year))];

// 🎨 Colors per year
const palette = ["#007bff","#28a745","#ffc107","#dc3545","#17a2b8","#6f42c1","#fd7e14","#20c997"];
const yearColors = {};
years.forEach((year, idx) => { yearColors[year] = palette[idx % palette.length]; });

// 📊 Map input data
const treeData = rawData.map(item => ({
    wtg: item.wtg,
    hours: item.hours,
    year: item.year
}));

const ctx = document.getElementById("treemapChart").getContext("2d");
const treemapChart = new Chart(ctx, {
    type: 'treemap',
    data: {
        datasets: [{
            tree: treeData,
            key: 'hours',
            groups: ['year','wtg'],   // ✅ still grouped by year → WTG
            spacing: 2,
            borderColor: '#ffffff',
            borderWidth: ctx => {
                // ✅ only draw borders for WTG level
                return ctx.raw._data && ctx.raw._data.wtg ? 1 : 0;
            },
            labels: {
                display: true,
                formatter: ctx => {
                    // ✅ Show only WTG labels (hide year completely)
                    if (ctx.raw._data && ctx.raw._data.wtg) {
                        return ctx.raw._data.wtg;
                    }
                    return ""; // 🔥 no year label
                },
                align: 'center',
                color: '#ffffff',
                font: { size: 12 }
            },
            backgroundColor: ctx =>
                yearColors[ctx.raw._data?.year] || "#6c757d"
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    generateLabels: chart => years.map(year => ({
                        text: year,
                        fillStyle: yearColors[year]
                    }))
                },
                // 🔍 highlight by year on hover
                onHover: (e, legendItem, legend) => {
                    const year = legendItem.text;
                    treemapChart.data.datasets[0].backgroundColor = ctx =>
                        ctx.raw._data?.year === year
                            ? yearColors[ctx.raw._data.year]
                            : "rgba(200,200,200,0.3)";
                    treemapChart.update();
                },
                onLeave: () => {
                    treemapChart.data.datasets[0].backgroundColor = ctx =>
                        yearColors[ctx.raw._data?.year] || "#6c757d";
                    treemapChart.update();
                }
            },
            tooltip: {
                callbacks: {
                    label: ctx => {
                        if (!ctx.raw._data || !ctx.raw._data.wtg) return null;
                        return `${ctx.raw._data.wtg} (${ctx.raw._data.year}): ${ctx.raw._data.hours.toLocaleString()} hrs`;
                    }
                }
            }
        }
    }
});

</script>

{% endblock %}
