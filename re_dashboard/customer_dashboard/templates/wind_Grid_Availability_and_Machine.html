{% extends "basewind.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container my-4" style="margin-top: 70px !important;">
    

  <!-- Active filters chips -->
  <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
    {% if date_from or date_to or selected_providers or selected_customers or selected_states or selected_sites or selected_wtgs %}
      <span class="badge bg-secondary">Active filters:</span>
      {% if date_from %}<span class="badge bg-light text-dark">From: {{ date_from }}</span>{% endif %}
      {% if date_to %}<span class="badge bg-light text-dark">To: {{ date_to }}</span>{% endif %}
      {% for x in selected_providers %}<span class="badge bg-info text-dark">Provider: {{ x }}</span>{% endfor %}
      {% for x in selected_customers %}<span class="badge bg-info text-dark">Customer: {{ x }}</span>{% endfor %}
      {% for x in selected_states %}<span class="badge bg-info text-dark">State: {{ x }}</span>{% endfor %}
      {% for x in selected_sites %}<span class="badge bg-info text-dark">Site: {{ x }}</span>{% endfor %}
      {% for x in selected_wtgs %}<span class="badge bg-info text-dark">WTG: {{ x }}</span>{% endfor %}
      <a class="btn btn-sm btn-outline-danger ms-2" href="?">Clear all</a>
    {% endif %}
  </div>

  <!-- Filter buttons same as other pages -->

  <!-- Filter Buttons -->
  <div class="d-flex flex-wrap gap-2 mb-4">
    <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#dateRangeModal">
      <i class="fas fa-filter"></i> DATE RANGE
    </button>
    <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#providerModal">
      <i class="fas fa-filter"></i> OEM PROVIDER
    </button>
    <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#customerModal">
      <i class="fas fa-filter"></i> CUSTOMER
    </button>
    <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#stateModal">
      <i class="fas fa-filter"></i> STATE NAME
    </button>
    <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#siteModal">
      <i class="fas fa-filter"></i> SITE NAME
    </button>
    <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#wtgModal">
      <i class="fas fa-filter"></i> WTG NUMBER
    </button>
  </div>

  <div class="card shadow-lg border-0 h-100 chart-card">
<div class="card-header form-heading d-flex justify-content-between align-items-center">
  <strong>Average Grid Failure by Year</strong>

  <!-- Dropdown Toggle -->
  <div class="dropdown">
    <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="gridMenu" data-bs-toggle="dropdown" aria-expanded="false">
      â˜°
    </button>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="gridMenu">
      <li><a class="dropdown-item" href="#" onclick="downloadChart('gridFailureChart','png')">Download PNG</a></li>
      <li><a class="dropdown-item" href="#" onclick="downloadChart('gridFailureChart','svg')">Download SVG</a></li>
      <li><a class="dropdown-item" href="#" onclick="downloadCSV(gridData,'Grid_Failure.csv')">Download CSV</a></li>
    </ul>
  </div>
</div>

    <div class="card-body">
      <canvas id="gridFailureChart" height="400px"></canvas>
    </div>
  </div>
</div>


<!-- ========== Modals ========== --> 
<!-- Date Range Modal -->
<div class="modal fade" id="dateRangeModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select Date Range</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body d-flex gap-2">
        <input type="date" name="date_from" value="{{ date_from }}" class="form-control">
        <input type="date" name="date_to" value="{{ date_to }}" class="form-control">
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key not in "date_from,date_to" %}
          {% for v in vals %}
            <input type="hidden" name="{{ key }}" value="{{ v }}">
          {% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Apply</button>
      </div>
    </form>
  </div>
</div>

<!-- Provider Modal -->
<div class="modal fade" id="providerModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Select Provider(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        {% for p in providers %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="provider" value="{{ p }}"
             {% if not selected_providers or p in selected_providers %}checked{% endif %}>
          <label class="form-check-label">{{ p }}</label>
          </div>
        {% empty %}<p class="text-muted">No providers found.</p>{% endfor %}
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key != "provider" %}
          {% for v in vals %}<input type="hidden" name="{{ key }}" value="{{ v }}">{% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer"><button type="submit" class="btn btn-primary">Apply</button></div>
    </form>
  </div>
</div>
<!-- Customer Modal -->
<div class="modal fade" id="customerModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Select Customer(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        {% for c in customers %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="customer" value="{{ c }}"
              {% if not selected_customers or c in selected_customers %}checked{% endif %}>
            <label class="form-check-label">{{ c }}</label>
          </div>
        {% empty %}<p class="text-muted">No customers found.</p>{% endfor %}
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key != "customer" %}
          {% for v in vals %}<input type="hidden" name="{{ key }}" value="{{ v }}">{% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer"><button type="submit" class="btn btn-primary">Apply</button></div>
    </form>
  </div>
</div>

<!-- State Modal -->
<div class="modal fade" id="stateModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Select State(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        {% for s in states %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="state" value="{{ s }}"
              {% if not selected_states or s in selected_states %}checked{% endif %}>
            <label class="form-check-label">{{ s }}</label>
          </div>
        {% empty %}<p class="text-muted">No states found.</p>{% endfor %}
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key != "state" %}
          {% for v in vals %}<input type="hidden" name="{{ key }}" value="{{ v }}">{% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer"><button type="submit" class="btn btn-primary">Apply</button></div>
    </form>
  </div>
</div>

<!-- Site Modal -->
<div class="modal fade" id="siteModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Select Site(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        {% for s in sites %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="site" value="{{ s }}"
              {% if not selected_sites or s in selected_sites %}checked{% endif %}>
            <label class="form-check-label">{{ s }}</label>
          </div>
        {% empty %}<p class="text-muted">No sites found.</p>{% endfor %}
      </div>
      {% for key,vals in request.GET.lists %}
        {% if key != "site" %}
          {% for v in vals %}<input type="hidden" name="{{ key }}" value="{{ v }}">{% endfor %}
        {% endif %}
      {% endfor %}
      <div class="modal-footer"><button type="submit" class="btn btn-primary">Apply</button></div>
    </form>
  </div>
</div>

<!-- Date Range Modal reused from other pages -->
<!-- Add other modals as needed, or reuse from base template -->

<style>
  .chart-card { border-radius: 15px; }
  .form-heading {
    background: linear-gradient(to right, #7b2cbf, #9d4edd);
    color: #fff;
    padding: 15px 25px;
    border-top-left-radius: 15px !important;
    border-top-right-radius: 15px !important;
    font-size: 18px;
    font-weight: 500;
    text-align: center !important;
  }
.dropdown-toggle {
  border: none;
  background: transparent;
  font-size: 18px;
  cursor: pointer;
}

  @media (max-width: 991px) {
  .nav-link {
    width: 110px !important;
  }
}
</style>
<script>
function downloadChart(chartId, type) {
  const chartCanvas = document.getElementById(chartId);

  if (type === "png") {
    const link = document.createElement("a");
    link.href = chartCanvas.toDataURL("image/png");
    link.download = chartId + ".png";
    link.click();
  } else if (type === "svg") {
    const svgData = `
      <svg xmlns="http://www.w3.org/2000/svg" width="${chartCanvas.width}" height="${chartCanvas.height}">
        <foreignObject width="100%" height="100%">
          ${new XMLSerializer().serializeToString(chartCanvas)}
        </foreignObject>
      </svg>`;
    const blob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = chartId + ".svg";
    link.click();
  }
}

function downloadCSV(data, filename) {
  let csv = "Year,Avg Grid Failure (%)\n";
  data.forEach(row => {
    csv += `${row.year},${row.avg_failure}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script>
  const gridData = {{ grid_chart_data|safe }};
  const labels = gridData.map(r => r.year);
  const values = gridData.map(r => r.avg_failure);

  // Google color palette
  const baseColors = ['#4285F4', '#EA4335', '#FBBC05', '#34A853'];
  const colors = values.map((_, i) => baseColors[i % baseColors.length]);

  const ctx = document.getElementById("gridFailureChart").getContext('2d');

  // Create gradient fills dynamically
  const createGradient = (ctx, color) => {
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, color);
    gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
    return gradient;
  };

  const gradientColors = colors.map(color => createGradient(ctx, color));

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: "Avg Grid Failure (%)",
          data: values,
          backgroundColor: gradientColors,
          borderColor: colors,
          borderWidth: 2,
          borderRadius: 12,
          borderSkipped: false,
          hoverBackgroundColor: colors.map(color => color + '99'),
          hoverBorderColor: colors.map(color => color + 'FF')
        },
        {
          type: 'line',
          label: 'Trend Line',
          data: values,
          borderColor: '#FF9900',
          backgroundColor: 'rgba(255, 153, 0, 0.1)',
          borderWidth: 4,
          fill: true,
          tension: 0.4,
          pointRadius: 6,
          pointHoverRadius: 8,
          pointBackgroundColor: '#FF9900',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          yAxisID: 'y'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: {
        duration: 2000,
        easing: 'easeInOutCubic'
      },
      interaction: {
        intersect: false,
        mode: 'nearest'
      },
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            usePointStyle: true,
            pointStyle: 'circle',
            boxWidth: 12,
            padding: 20
          }
        },
        tooltip: {
          enabled: true,
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: '#ddd',
          borderWidth: 1,
          padding: 10,
          callbacks: {
            title: function(context) {
              return 'Year: ' + context[0].label;
            },
            label: function(context) {
              return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
            }
          }
        },
        datalabels: {
          anchor: 'end',
          align: 'top',
          formatter: (value) => value.toFixed(2) + '%',
          color: '#333',
          font: { weight: 'bold', size: 12 },
          backgroundColor: 'rgba(255, 255, 255, 0.8)',
          borderRadius: 4,
          padding: 1,
          display: function(context) {
            // Only show labels for bars, not the trend line
            return context.dataset.label !== 'Trend Line';
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Avg Grid Failure (%)',
            font: { size: 14, weight: 'bold' },
            color: '#333'
          },
          ticks: {
            callback: function(value) {
              return value.toFixed(1) + '%';
            },
            color: '#666',
            font: { size: 10 }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.1)',
            borderDash: [5, 5]
          }
        },
        x: {
          title: {
            display: true,
            text: 'Year',
            font: { size: 14, weight: 'bold' },
            color: '#333'
          },
          grid: {
            display: false
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
</script>
{% if no_data %}
<script>
Swal.fire({
  icon: 'info',
  title: 'No Data',
  text: '{{ no_data_msg }}',
  confirmButtonColor: '#3085d6'
});
</script>
{% endif %}

{% endblock %}
